from metasploit.msfrpc import MsfRpcClient
from time import sleep
import ipaddress

def success_string():
    return "64 bytes from"



def remote_host_scan(client:MsfRpcClient, metasploitSessionNum:int):
    try:
        success, ipAddress = remote_host_netinfo(client, metasploitSessionNum)[3]
        shell = client.sessions.session(metasploitSessionNum)
        toReturn = [] #List of lists, each sublist from a different network
        for network in ipAddress:
            networkAddress = network.IPv4Network(ipaddress, strict=False)[2]
            foundAddresses = []
            for address in networkAddress:
                shell.write("ping -c 3 {}\n".format(address))
                sleep(3)
                output = shell.read()
                if (success_string() in output):
                    foundAddresses.append(str(address))
                else:
                    pass
            foundAddresses.append(toReturn)
        return toReturn
    except:
        return -1, "{}"

def remote_host_netinfo(client:MsfRpcClient, metasploitSessionNum:int):
    try:
        shell = client.sessions.session(metasploitSessionNum)
        shell.write("ip a\n")
        sleep(1)
        shell_output = shell.read()
        ips = ip_a_parse(shell_output)
        return 0, ips
    except:
        return -1, "[]"



"""Documentation for the below found in Identifier/networkinfo/ip_a_netinfo"""
def ip_a_regex():
    return r"\d: (.*):.*\n\s*link.* (.*) brd.*\n\s*inet ([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\/[0-9]+) " \
           "(?:brd)? ([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)"

def ip_a_parse(output:str):
    pattern = compile(ip_a_regex())
    matches = pattern.findall(output)
    toReturn = []
    for match in matches:
        toReturn.append(list(match))
    return toReturn
